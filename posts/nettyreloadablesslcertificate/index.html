<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Netty reloading SSL/TLS certificate">
    <meta property="og:site_name" content="Goldius company site">
    <title>Netty reloading SSL/TLS certificate</title>
    <meta name="description" content="Reloading SSL certificate without restarting the server.">
    <meta name="author" content="Aleksandar Zlatkovic">

<link href="https://fonts.googleapis.com/css2?family=Alegreya:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Goldius Software Company">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Goldius Software Company">

 <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-180696615-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-180696615-1');
  </script>
  <script type="application/ld+json">
  {
      "@context": "http://schema.org/",
      "@type": "Person",
      "name": "Aleksandar Zlatkovic",
      "alternateName": "Goldius, atozncoder, NCODER",
      "url": "https://www.goldius.org",
      "image": "",
      "sameAs": [
          "https://github.com/atozncoder",
          "https://twitter.com/alekszlatkovic",
          "https://www.linkedin.com/in/aleksandarzlatkovic/"
      ]
  }
  </script>
  </head>
  <body class="center">
    <header>
      <h1 class="home"><a href="/">Goldius Software Company</a></h1>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/jobs/">Jobs</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>

    <main class="tmpl-post">

      <h1>Netty reloading SSL/TLS certificate</h1>
<div style="background-color: lightgrey">
<h3><a href="/jobs">We are hiring</a></h3>
If you are interesed in working on high class problems that include Java, AWS, big data and much, much more, join us.
<h4><a href="/jobs"><font color="red">Click to checkout available positions.</font></a></h4>
</div>

<p>Security is hot topic these days. Data has to be protected. Regulations have to be followed. Encrypted is the buzzword and more often than not SSL/TLS is a way to do it.</p>
<p>Setting SSL/TLS implies having valid CA signed certificate on the server.  Please check the previous post, <a href="/posts/casignednettysecuredchat/">Netty SSL with CA signed certificates</a>, for explanations on how to create SSL certificates and used them to run netty secured chat example.</p>
<p>In addition more often than not security standards require for certificates to be reloaded periodically. To solve this some basic understanding of TLS handshake and Netty channel bootstrapping is required.</p>
<p>Let’s begin…</p>
<h2 id="tls%2Fssl-handshake">TLS/SSL handshake <a class="direct-link" href="#tls%2Fssl-handshake">#</a></h2>
<p>TLS use symmetric encryption to encrypt and decrypt traffic between client and server. When negotiating the TLS session at some point client and server create the session key and use it for symmetric encryption.</p>
<p>More details on how this handshake process works can be found in <a href="https://www.cloudflare.com/learning/ssl/what-happens-in-a-tls-handshake/">What is a TLS handshake?</a> article on Cloudflare.</p>
<p>We will skip the details here, but the important thing to note is the step #6 from mentioned article. This step states:<br>
<strong>6. Session keys created</strong>: <em>Both client and server generate session keys from the client random, the server random, and the premaster secret. They should arrive at the same results.</em></p>
<p>What this means is that certificate is only used for handshake and for creation of session key in process of establishing the session. Each new session will create new session key.</p>
<p>Based on the above we can replace our server certificate at any time. Client that is already connected to server will not lose connection as it already negotiated session key. Later clients can handshake with new key loaded in the meantime. Both clients should be able to stay connected, regardless to the server cert used for TLS handshake.</p>
<p>Following diagram shows two clients connecting to server with TLS cert reloaded:<br>
<img src="/img/nettyreloadablesslcertificate/tls_reload.png" alt="tls_reload"></p>
<h2 id="netty-server-bootstrapping">Netty Server Bootstrapping <a class="direct-link" href="#netty-server-bootstrapping">#</a></h2>
<p>Netty server bootstrapping involves binding a process to a given port for each client that requests a connection. Each time a requests for a connection is received, netty server creates a channel and binds a port. In this process and when SSL is enabled, netty will load SSL engine. We can plugin our implementation of <code>SslContext</code> here and take over the cert load process from disk or wherever the cert files are stored.</p>
<h2 id="implementation">Implementation <a class="direct-link" href="#implementation">#</a></h2>
<p>Implementation of the context is quite simple. Below is the important code that does what we need:</p>
<pre><code>public class ReloadableSslContext extends SslContext {
    private SslContext sslContext;
    private SSLEngine sslEngine;

    public ReloadableSslContext() throws SSLException {
        Configuration cfg = ConfigFactory.create(Configuration.class);
        loadContext(cfg.serverCertPath(), cfg.serverKeyPath());
    }

    private void loadContext(String certPath, String keyPath) throws SSLException {
        InputStream keyCertChainIS = getClass().getResourceAsStream(certPath);
        InputStream keyIS =getClass().getResourceAsStream(keyPath);
        sslContext = SslContextBuilder.forServer(keyCertChainIS, keyIS).build();
    }

    public void reload(String certPath, String keyPath) throws SSLException {
        loadContext(certPath, keyPath);
    }
    .
    .
    .
</code></pre>
<p><strong>Note</strong>: This code is not thread safe and is only shown as an example of design approach and not as production ready code.</p>
<h2 id="usage">Usage <a class="direct-link" href="#usage">#</a></h2>
<p>Reloadable SSL context can be used when creating server channel same as any other SSLContext implementation.<br>
Code example:</p>
<pre><code>public void start() throws InterruptedException, SSLException {

    Configuration cfg = ConfigFactory.create(Configuration.class);

    sslCtx = new ReloadableSslContext();

    EventLoopGroup bossGroup = new NioEventLoopGroup(1);
    EventLoopGroup workerGroup = new NioEventLoopGroup();

    try {
        bootstrap = new ServerBootstrap();
        bootstrap.group(bossGroup, workerGroup)
                .channel(NioServerSocketChannel.class)
                .handler(new LoggingHandler(LogLevel.INFO))
                .childHandler(new SecureChatServerInitializer(sslCtx));

        bootstrap.bind(cfg.port()).sync().channel().closeFuture().sync();
    } finally {
        bossGroup.shutdownGracefully();
        workerGroup.shutdownGracefully();
    }
}
</code></pre>
<p>And then the secure channel server initialiser uses it as follows:</p>
<pre><code>pipeline.addLast(sslCtx.newHandler(ch.alloc()));
</code></pre>
<p>And we can call it to relaod certs any time we want, we just provide the path to cert files:</p>
<pre><code>sslContext).reload(cfg.serverCertPath2(), cfg.serverKeyPath2())
</code></pre>
<h2 id="demo">Demo <a class="direct-link" href="#demo">#</a></h2>
<p>Checkout or download the sourece code from git: <a href="https://github.com/atozncoder/netty_secured_chat/tree/relodable_ssl">https://github.com/atozncoder/netty_secured_chat/tree/relodable_ssl</a></p>
<p>Use relodable_ssl branch.</p>
<p>In a console run following 2 commands:</p>
<pre><code>mvn clean package
java -jar target/netty_seccured_chat-1.0-SNAPSHOT-jar-with-dependencies.jar server
</code></pre>
<p>In second console run following 2 commands:</p>
<pre><code>java -jar target/netty_seccured_chat-1.0-SNAPSHOT-jar-with-dependencies.jar client
ssl reload
</code></pre>
<p>Note that connection message shows that server cert subject is: <code>Subject DN: CN=goldius.rd.netty.ssl.org</code>.</p>
<p>The <code>ssl reload</code> command will be handlen by server so that it would use diferent cert from that moment.</p>
<p>In third console run following</p>
<pre><code>java -jar target/netty_seccured_chat-1.0-SNAPSHOT-jar-with-dependencies.jar client
</code></pre>
<p>Note the connection message and that it shows that cert subject changed to: <code>Subject DN: CN=goldius.rd.netty_2.ssl.org</code>.</p>
<p>Test both clients connections by sending any message.</p>

<div style="background-color: lightgrey">
<h3><a href="/jobs">We are hiring</a></h3>
If you are interesed in working on high class problems that include Java, AWS, big data and much, much more, join us.
<h4><a href="/jobs"><font color="red">Click to checkout available positions.</font></a></h4>
</div>


<hr>
<ul><li>Previous: <a href="/posts/casignednettysecuredchat/">Netty SSL/TLS with CA signed certificates</a></li>
</ul>


    </main>

    <footer></footer>

    <!-- Current page: /posts/nettyreloadablesslcertificate/ -->
  </body>
</html>
